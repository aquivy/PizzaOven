<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Forno de Pizza - RA em Tamanho Grande Aprimorado</title>
  <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.5.0/model-viewer.min.js"></script>
  <style>
    body {
      margin: 0;
      background-color: #f0f0f0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      color: #333;
      text-align: center;
      padding: 16px;
      box-sizing: border-box;
    }
    #ar-controls {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
      padding: 20px;
      background-color: #ffffff;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    #start-ar-button {
      background-color: #007aff;
      color: white;
      padding: 14px 28px; /* Aumentado o padding */
      border: none;
      border-radius: 8px;
      font-size: 18px; /* Aumentada a fonte */
      font-weight: 500;
      cursor: pointer;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      transition: background-color 0.3s ease, transform 0.1s ease;
    }
    #start-ar-button:hover {
      background-color: #005ecb;
    }
    #start-ar-button:active {
      transform: scale(0.98);
    }
    #start-ar-button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    #status-text {
      color: #555; /* Cor do texto um pouco mais escura */
      font-size: 15px; /* Aumentada a fonte */
      min-height: 22px; /* Para evitar saltos de layout */
    }
    /* Model Viewer inicialmente oculto para não interferir no layout */
    model-viewer {
      display: none; /* Será exibido via JavaScript ao carregar */
      width: 1px; /* Tamanho mínimo para permitir o carregamento em segundo plano */
      height: 1px;
      position: absolute; /* Remove do fluxo normal até ser necessário */
      left: -9999px;
    }
  </style>
</head>
<body>
  <div id="ar-controls">
    <h1>Forno de Pizza em Realidade Aumentada</h1>
    <button id="start-ar-button">Iniciar Realidade Aumentada</button>
    <div id="status-text">Clique no botão para carregar o modelo.</div>
    <p style="font-size: 12px; color: #777;">Certifique-se de que seu ambiente está bem iluminado e aponte para uma superfície plana.</p>
  </div>

  <model-viewer
    id="pizza-ar-viewer"
    src="pizza oven_resized.glb" /* IMPORTANTE: Certifique-se que este arquivo GLB está acessível e o caminho está correto! */
    alt="Forno de Pizza em RA"
    ar
    ar-modes="webxr scene-viewer quick-look"
    ar-placement="floor" /* Coloca o modelo no chão */
    ar-scale="fixed" /* Mantém a escala do modelo fixa na RA */
    ar-stability="medium" /* Tenta melhorar a estabilidade da ancoragem */
    autoplay /* Autoplay para animações, se houver */
    shadow-intensity="1"
    exposure="1.0"
    disable-tap /* Desabilita interações de toque no modelo em RA */
    camera-controls /* Habilita controles de câmera para o preview 3D */
    disable-pan /* Desabilita o pan no preview 3D */
    min-camera-orbit="auto 30deg auto" /* Ajusta a órbita mínima da câmera no preview 3D */
    max-camera-orbit="auto 100deg auto" /* Ajusta a órbita máxima da câmera no preview 3D */
    interaction-prompt="none" /* Remove o prompt de interação padrão */
    scale="12 12 12" /* Escala do modelo (dobrado) */
    field-of-view="30deg" /* Campo de visão para o preview 3D */
  >
    <div slot="ar-button" style="display: none;"></div>
  </model-viewer>

  <script>
    const startButton = document.getElementById('start-ar-button');
    const statusText = document.getElementById('status-text');
    const modelViewer = document.getElementById('pizza-ar-viewer');
    let modelLoaded = false;

    console.log("Tentando carregar modelo de:", modelViewer.src); // Log para verificar o caminho do modelo

    // Pré-carregar o modelo discretamente
    const preloadModel = async () => {
      // Se o modelo já foi carregado (por exemplo, por uma tentativa anterior ou cache)
      if (modelViewer.loaded) {
        modelLoaded = true;
        console.log("Modelo já estava carregado (modelViewer.loaded era true).");
        statusText.textContent = "Modelo pronto. Clique para iniciar RA.";
        startButton.disabled = false;
        return;
      }

      try {
        // Exibe o model-viewer minimizado para permitir o carregamento
        modelViewer.style.display = 'block';
        modelViewer.style.width = '1px';
        modelViewer.style.height = '1px';
        modelViewer.style.position = 'fixed'; // Garante que não afete o layout
        modelViewer.style.left = '-9999px'; // Fora da tela

        // Espera o model-viewer estar pronto para interações, não necessariamente o modelo carregado
        await modelViewer.updateComplete;
        
        // Verifica novamente se o modelo carregou após updateComplete (pode ser rápido do cache)
        if (modelViewer.loaded) {
            modelLoaded = true;
            console.log("Modelo pré-carregado rapidamente (possivelmente do cache).");
            statusText.textContent = "Modelo pronto. Clique para iniciar RA.";
            startButton.disabled = false;
            return;
        }

        // Adiciona listeners para os eventos 'load' e 'error'
        await new Promise((resolve, reject) => {
          const PRELOAD_TIMEOUT_MS = 30000; // Aumentado o timeout para 30 segundos
          let timeoutId = setTimeout(() => {
            console.error(`Tempo de ${PRELOAD_TIMEOUT_MS / 1000}s excedido ao pré-carregar modelo.`);
            reject(new Error(`Tempo excedido (${PRELOAD_TIMEOUT_MS / 1000}s) ao pré-carregar modelo. Verifique o arquivo e a conexão.`));
          }, PRELOAD_TIMEOUT_MS);

          const loadListener = () => {
            clearTimeout(timeoutId);
            modelLoaded = true;
            console.log("Modelo pré-carregado com sucesso via evento 'load'.");
            statusText.textContent = "Modelo pronto. Clique para iniciar RA.";
            startButton.disabled = false;
            resolve();
          };

          const errorListener = (event) => {
            clearTimeout(timeoutId);
            console.error("Erro explícito ao pré-carregar o modelo:", event.detail);
            statusText.textContent = "Erro ao carregar modelo. Verifique o console e o arquivo.";
            startButton.disabled = false; // Permite nova tentativa
            reject(new Error("Erro no pré-carregamento do modelo: " + (event.detail?.sourceError?.message || event.detail || "Erro desconhecido")));
          };
          
          modelViewer.addEventListener('load', loadListener, { once: true });
          modelViewer.addEventListener('error', errorListener, { once: true });
        });

      } catch (error) {
        console.error("Falha na função preloadModel:", error);
        statusText.textContent = `Falha ao preparar modelo: ${error.message}. Tente novamente.`;
        startButton.disabled = false; // Garante que o botão seja reabilitado em caso de erro no try/catch
      } finally {
        // Esconde o model-viewer novamente se ele foi usado para pré-carregar e não está em AR
        // e se o modelo não carregou com sucesso (para não esconder se já estiver pronto)
        if (modelViewer.style.position === 'fixed' && !modelLoaded) {
            modelViewer.style.display = 'none';
            modelViewer.style.position = 'absolute'; // Volta ao original
        } else if (modelViewer.style.position === 'fixed' && modelLoaded) {
            // Se carregou, pode manter escondido até o clique do botão de AR
             modelViewer.style.display = 'none';
             modelViewer.style.position = 'absolute';
        }
      }
    };

    // Inicia o pré-carregamento assim que o script for executado
    startButton.disabled = true;
    statusText.textContent = "Preparando modelo, por favor aguarde...";
    preloadModel();


    startButton.addEventListener('click', async () => {
      startButton.disabled = true;
      statusText.textContent = "Iniciando...";

      // Garante que o model-viewer esteja visível para ativar AR
      modelViewer.style.display = 'block';
      modelViewer.style.width = '100%';
      modelViewer.style.height = '100%';
      modelViewer.style.position = 'fixed'; // Usa fixed para sobrepor tudo
      modelViewer.style.left = '0';
      modelViewer.style.top = '0';
      modelViewer.style.zIndex = '1000';


      if (!modelLoaded) {
        statusText.textContent = "Aguardando carregamento final do modelo...";
        try {
          // Se o preload não completou ou falhou, tentamos carregar aqui novamente
          // ou esperamos o modelViewer.loaded se tornar true.
          if (!modelViewer.loaded) {
            await new Promise((resolve, reject) => {
              const finalLoadTimeout = setTimeout(() => reject(new Error("Tempo excedido ao carregar modelo para AR")), 15000);
              modelViewer.addEventListener('load', () => {
                clearTimeout(finalLoadTimeout);
                modelLoaded = true; // Confirma que está carregado
                resolve();
              }, { once: true });
              modelViewer.addEventListener('error', (event) => {
                clearTimeout(finalLoadTimeout);
                reject(new Error("Erro ao carregar modelo para AR: " + (event.detail?.sourceError?.message || event.detail)));
              }, { once: true });
            });
          } else {
            modelLoaded = true; // Já estava carregado
          }
          console.log("Modelo carregado e pronto para AR.");
        } catch (err) {
          console.error("Erro durante o carregamento para AR:", err);
          statusText.textContent = "Erro ao carregar modelo: " + err.message;
          startButton.disabled = false;
          modelViewer.style.display = 'none'; // Esconde se falhar
          modelViewer.style.position = 'absolute'; // Volta ao original
          return;
        }
      }

      statusText.textContent = "Iniciando Realidade Aumentada...";
      await new Promise(r => setTimeout(r, 500)); // Pequeno delay para o usuário ler a mensagem

      try {
        console.log("Tentando ativar AR...");
        await modelViewer.activateAR();
        console.log("AR ativado ou tentativa de ativação em progresso.");
        // O status text é atualizado pelos eventos ar-status
      } catch (err) {
        console.error("Erro ao iniciar RA:", err);
        statusText.textContent = "Erro ao iniciar RA: " + err.message + ". Verifique se seu dispositivo suporta RA e concedeu permissões.";
        startButton.disabled = false;
        modelViewer.style.display = 'none'; // Esconde se falhar
        modelViewer.style.position = 'absolute'; // Volta ao original
      }
    });

    // Lidar com os status da sessão de RA
    modelViewer.addEventListener('ar-status', (event) => {
        console.log('AR Status Event:', event.detail.status);
        const arControls = document.getElementById('ar-controls');
        switch(event.detail.status) {
            case 'not-presenting':
                statusText.textContent = "RA finalizada. Clique para iniciar novamente.";
                startButton.disabled = false;
                modelViewer.style.display = 'none';
                modelViewer.style.position = 'absolute';
                if (arControls) arControls.style.display = 'flex'; // Mostra os controles novamente
                break;
            case 'session-started':
                statusText.textContent = "RA ativa. Mova seu dispositivo para encontrar uma superfície.";
                if (arControls) arControls.style.display = 'none'; // Esconde os controles
                break;
            case 'failed':
                statusText.textContent = "Falha ao iniciar a sessão de RA. Verifique as permissões e o suporte do dispositivo.";
                startButton.disabled = false;
                modelViewer.style.display = 'none';
                modelViewer.style.position = 'absolute';
                if (arControls) arControls.style.display = 'flex';
                break;
            case 'consent-needed': // Pode ser útil para alguns fluxos
                 statusText.textContent = "Permissão necessária para RA.";
                 break;
        }
    });

    modelViewer.addEventListener('ar-tracking', (event) => {
        // console.log('AR Tracking Event:', event.detail.state);
        if (event.detail.state === 'tracking') {
            // statusText.textContent = "Superfície detectada, posicionando..."; // Pode ser muito verboso
        } else if (event.detail.state === 'not-tracking') {
            // statusText.textContent = "Procurando superfície... Mantenha o dispositivo firme.";
        }
    });

  </script>
</body>
</html>
