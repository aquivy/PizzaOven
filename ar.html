<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Forno de Pizza - RA em Tamanho Grande Aprimorado</title>
  <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.5.0/model-viewer.min.js"></script>
  <style>
    body {
      margin: 0;
      background-color: #f0f0f0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      color: #333;
      text-align: center;
      padding: 16px;
      box-sizing: border-box;
    }
    #ar-controls {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
      padding: 20px;
      background-color: #ffffff;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      z-index: 10;
    }
    #start-ar-button {
      background-color: #007aff;
      color: white;
      padding: 14px 28px;
      border: none;
      border-radius: 8px;
      font-size: 18px;
      font-weight: 500;
      cursor: pointer;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      transition: background-color 0.3s ease, transform 0.1s ease;
    }
    #start-ar-button:hover {
      background-color: #005ecb;
    }
    #start-ar-button:active {
      transform: scale(0.98);
    }
    #start-ar-button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    #status-text {
      color: #555;
      font-size: 15px;
      min-height: 60px; /* Aumentado para mais texto */
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column; /* Para empilhar mensagens */
    }
    model-viewer {
      display: none;
      width: 1px; 
      height: 1px;
      position: absolute; 
      left: -9999px; 
      background-color: transparent;
    }
  </style>
</head>
<body>
  <div id="ar-controls">
    <h1>Forno de Pizza em Realidade Aumentada</h1>
    <button id="start-ar-button">Iniciar Realidade Aumentada</button>
    <div id="status-text">Clique no botão para carregar o modelo.</div>
    <p style="font-size: 12px; color: #777;">Certifique-se de que seu ambiente está bem iluminado e aponte para uma superfície plana.</p>
  </div>

  <model-viewer
    id="pizza-ar-viewer"
    src="https://raw.githubusercontent.com/julianambatista/PizzaOven/main/pizza%20oven_resized.glb" /* URL do seu modelo no GitHub */
    alt="Forno de Pizza em RA"
    ar
    ar-modes="webxr scene-viewer quick-look" /* Fallbacks para Android e iOS */
    ar-placement="floor"
    ar-scale="fixed"
    ar-stability="medium"
    autoplay
    shadow-intensity="1"
    exposure="1.0"
    disable-tap
    camera-controls
    disable-pan
    min-camera-orbit="auto 30deg auto"
    max-camera-orbit="auto 100deg auto"
    interaction-prompt="none"
    scale="12 12 12"
    field-of-view="30deg"
  >
    <div slot="ar-button" style="display: none;"></div>
  </model-viewer>

  <script>
    const startButton = document.getElementById('start-ar-button');
    const statusText = document.getElementById('status-text');
    const modelViewer = document.getElementById('pizza-ar-viewer');
    let modelLoaded = false;
    let preloadAttempted = false;

    console.log("Script iniciado. Tentando carregar modelo de:", modelViewer.src);
    statusText.innerHTML = "Verificando suporte a WebXR...";

    if (!navigator.xr) {
        console.warn("WebXR não é suportado neste navegador/dispositivo.");
        statusText.innerHTML = "Realidade Aumentada (WebXR) não é suportada neste navegador ou dispositivo.<br>Alguns modos alternativos podem funcionar.";
        // Não desabilitar o botão, pois scene-viewer/quick-look podem funcionar
    } else {
        console.log("WebXR é suportado.");
        statusText.innerHTML = "WebXR suportado. Clique no botão para carregar o modelo.";
    }


    const preloadModel = async () => {
      preloadAttempted = true;
      console.log("preloadModel chamado. modelViewer.loaded:", modelViewer.loaded);
      statusText.innerHTML = "Iniciando carregamento do modelo (aprox 7.2MB)...<br>Isso pode levar um momento, por favor aguarde.";


      if (modelViewer.loaded) {
        modelLoaded = true;
        console.log("Modelo já estava carregado.");
        statusText.textContent = "Modelo pronto. Clique para iniciar RA.";
        startButton.disabled = false;
        return;
      }

      modelViewer.style.display = 'block';
      console.log("model-viewer display set to 'block' for preloading.");

      try {
        console.log("Aguardando modelViewer.updateComplete...");
        await modelViewer.updateComplete;
        console.log("modelViewer.updateComplete resolvido. modelViewer.loaded:", modelViewer.loaded);
        
        if (modelViewer.loaded) {
            modelLoaded = true;
            console.log("Modelo carregado após modelViewer.updateComplete.");
            statusText.textContent = "Modelo pronto. Clique para iniciar RA.";
            startButton.disabled = false;
            modelViewer.style.display = 'none'; 
            return;
        }

        console.log("Modelo não carregado após updateComplete. Aguardando evento 'load' ou 'error'.");
        await new Promise((resolve, reject) => {
          const PRELOAD_TIMEOUT_MS = 60000; // 60 segundos de timeout
          let timeoutId = setTimeout(() => {
            const errorMsg = `Tempo de ${PRELOAD_TIMEOUT_MS / 1000}s excedido ao pré-carregar modelo: ${modelViewer.src}.<br>Verifique sua conexão ou tente novamente. O arquivo é grande (7.2MB).`;
            console.error(errorMsg.replace('<br>', ' '));
            reject(new Error(errorMsg));
          }, PRELOAD_TIMEOUT_MS);

          const loadListener = () => {
            clearTimeout(timeoutId);
            modelLoaded = true;
            console.log("Modelo pré-carregado com sucesso via evento 'load':", modelViewer.src);
            statusText.textContent = "Modelo pronto! Clique para iniciar RA.";
            startButton.disabled = false;
            resolve();
          };

          const errorListener = (event) => {
            clearTimeout(timeoutId);
            const errorDetail = event.detail?.sourceError?.message || event.detail?.message || event.detail || "Erro desconhecido";
            console.error(`Erro explícito ao pré-carregar o modelo (${modelViewer.src}):`, errorDetail, event.detail);
            statusText.innerHTML = `Erro ao carregar modelo (${modelViewer.src.substring(modelViewer.src.lastIndexOf('/')+1)}).<br>Detalhe: ${errorDetail}.<br>Verifique o console e a conexão.`;
            startButton.disabled = false; 
            reject(new Error(`Erro no pré-carregamento do modelo: ${errorDetail}`));
          };
          
          modelViewer.addEventListener('load', loadListener, { once: true });
          modelViewer.addEventListener('error', errorListener, { once: true });
        });

      } catch (error) {
        console.error("Falha na função preloadModel:", error.message);
        statusText.innerHTML = `Falha ao preparar modelo: ${error.message.replace(/\n/g, '<br>')}`;
        startButton.disabled = false;
      } finally {
        if (modelLoaded) {
            modelViewer.style.display = 'none';
            console.log("Modelo carregado, model-viewer display set to 'none'.");
        } else if (modelViewer.style.display === 'block') {
            modelViewer.style.display = 'none';
            console.log("Pré-carregamento falhou ou não concluído, model-viewer display set to 'none'.");
        }
      }
    };

    startButton.disabled = true; // Será habilitado após verificação do WebXR e/ou preload
    // A mensagem inicial de status já é definida após a verificação do WebXR.
    // Se WebXR for suportado, o preloadModel será chamado.
    if (navigator.xr) {
        preloadModel();
    } else {
        // Se WebXR não for suportado, o usuário ainda pode tentar com scene-viewer/quick-look
        startButton.disabled = false; 
        // A mensagem já foi definida para "WebXR não suportado..."
    }


    startButton.addEventListener('click', async () => {
      console.log("Botão 'Iniciar Realidade Aumentada' clicado.");
      startButton.disabled = true;
      statusText.textContent = "Iniciando...";
      
      modelViewer.style.display = 'block'; 
      modelViewer.style.width = '100vw'; 
      modelViewer.style.height = '100vh';
      modelViewer.style.position = 'fixed'; 
      modelViewer.style.left = '0';
      modelViewer.style.top = '0';
      modelViewer.style.zIndex = '1000'; 
      console.log("model-viewer preparado para AR (display: block, fullscreen).");

      if (!modelLoaded) {
        statusText.innerHTML = "Aguardando carregamento final do modelo...<br>Verifique sua conexão.";
        console.log("Modelo não estava pré-carregado, tentando carregar agora para AR.");
        try {
          if (!modelViewer.loaded) {
            await new Promise((resolve, reject) => {
              const finalLoadTimeout = setTimeout(() => reject(new Error("Tempo excedido ao carregar modelo para AR (final).")), 30000); 
              
              const finalLoadListener = () => { clearTimeout(finalLoadTimeout); modelLoaded = true; resolve(); };
              const finalErrorListener = (event) => { 
                clearTimeout(finalLoadTimeout); 
                const errorDetail = event.detail?.sourceError?.message || event.detail?.message || "Erro desconhecido";
                reject(new Error(`Erro ao carregar modelo para AR (final): ${errorDetail}`));
              };

              modelViewer.addEventListener('load', finalLoadListener, { once: true });
              modelViewer.addEventListener('error', finalErrorListener, { once: true });
            });
          } else {
            modelLoaded = true; 
          }
          console.log("Modelo carregado e pronto para AR (no clique).");
        } catch (err) {
          console.error("Erro durante o carregamento para AR (no clique):", err.message);
          statusText.innerHTML = "Erro ao carregar modelo: " + err.message + "<br>Tente novamente.";
          startButton.disabled = false;
          modelViewer.style.display = 'none'; 
          return;
        }
      }

      statusText.textContent = "Iniciando Realidade Aumentada...";
      await new Promise(r => setTimeout(r, 500)); 

      try {
        console.log("Tentando ativar AR (modelViewer.activateAR())...");
        // Verifica se o AR está disponível antes de tentar ativar
        if (!modelViewer.canActivateAR) {
            console.warn("modelViewer.canActivateAR é false. O dispositivo pode não suportar os modos de AR configurados ou WebXR.");
            statusText.innerHTML = "Não foi possível ativar RA.<br>Seu dispositivo pode não suportar os modos de RA necessários (WebXR, SceneViewer ou QuickLook).";
            startButton.disabled = false;
            modelViewer.style.display = 'none';
            return;
        }
        await modelViewer.activateAR();
        console.log("Comando activateAR() enviado. Aguardando status da sessão AR...");
      } catch (err) {
        console.error("Erro ao chamar activateAR():", err.message);
        statusText.innerHTML = "Erro ao iniciar RA: " + err.message + "<br>Verifique permissões e suporte do dispositivo.";
        startButton.disabled = false;
        modelViewer.style.display = 'none'; 
      }
    });

    modelViewer.addEventListener('ar-status', (event) => {
        console.log('AR Status Event:', event.detail.status);
        const arControls = document.getElementById('ar-controls');
        switch(event.detail.status) {
            case 'not-presenting':
                statusText.textContent = "RA finalizada. Clique para iniciar novamente.";
                startButton.disabled = false;
                modelViewer.style.display = 'none'; 
                if (arControls) arControls.style.display = 'flex';
                break;
            case 'session-started':
                statusText.textContent = "RA ativa. Mova seu dispositivo para encontrar uma superfície.";
                if (arControls) arControls.style.display = 'none';
                break;
            case 'failed':
                statusText.innerHTML = "Falha ao iniciar a sessão de RA.<br>Verifique permissões/suporte do dispositivo.";
                startButton.disabled = false;
                modelViewer.style.display = 'none';
                if (arControls) arControls.style.display = 'flex';
                break;
            case 'consent-needed': 
                 statusText.textContent = "Permissão necessária para RA.";
                 console.log("AR consent needed.");
                 break;
        }
    });

    modelViewer.addEventListener('progress', (event) => {
        if (!modelLoaded && preloadAttempted && modelViewer.style.display === 'block') { 
            const percentage = Math.floor(event.detail.totalProgress * 100);
            statusText.innerHTML = `Carregando modelo (7.2MB): ${percentage}%<br>Por favor, aguarde...`;
        }
    });

  </script>
</body>
</html>
