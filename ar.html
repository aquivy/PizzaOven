<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Forno de Pizza - RA em Tamanho Grande Aprimorado</title>
  <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.5.0/model-viewer.min.js"></script>
  <style>
    body {
      margin: 0;
      background-color: #f0f0f0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      color: #333;
      text-align: center;
      padding: 16px;
      box-sizing: border-box;
    }
    #ar-controls {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
      padding: 20px;
      background-color: #ffffff;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      z-index: 10; /* Para garantir que os controles fiquem visíveis inicialmente */
    }
    #start-ar-button {
      background-color: #007aff;
      color: white;
      padding: 14px 28px;
      border: none;
      border-radius: 8px;
      font-size: 18px;
      font-weight: 500;
      cursor: pointer;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      transition: background-color 0.3s ease, transform 0.1s ease;
    }
    #start-ar-button:hover {
      background-color: #005ecb;
    }
    #start-ar-button:active {
      transform: scale(0.98);
    }
    #start-ar-button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    #status-text {
      color: #555;
      font-size: 15px;
      min-height: 44px; /* Aumentado para acomodar mensagens mais longas */
      display: flex;
      align-items: center;
      justify-content: center;
    }
    model-viewer {
      /* Inicialmente escondido, mas será 'block' durante o preload */
      display: none;
      width: 1px; /* Mínimo para permitir carregamento */
      height: 1px;
      position: absolute; /* Fora do fluxo normal */
      left: -9999px; /* Fora da tela */
      background-color: transparent; /* Para não causar flash se aparecer brevemente */
    }
  </style>
</head>
<body>
  <div id="ar-controls">
    <h1>Forno de Pizza em Realidade Aumentada</h1>
    <button id="start-ar-button">Iniciar Realidade Aumentada</button>
    <div id="status-text">Clique no botão para carregar o modelo.</div>
    <p style="font-size: 12px; color: #777;">Certifique-se de que seu ambiente está bem iluminado e aponte para uma superfície plana.</p>
  </div>

  <model-viewer
    id="pizza-ar-viewer"
    src="https://modelviewer.dev/shared-assets/models/Astronaut.glb" /* <--- SUBSTITUA ESTA URL DE EXEMPLO PELA SUA */
    alt="Modelo 3D em RA"
    ar
    ar-modes="webxr scene-viewer quick-look"
    ar-placement="floor"
    ar-scale="fixed"
    ar-stability="medium"
    autoplay
    shadow-intensity="1"
    exposure="1.0"
    disable-tap
    camera-controls
    disable-pan
    min-camera-orbit="auto 30deg auto"
    max-camera-orbit="auto 100deg auto"
    interaction-prompt="none"
    scale="12 12 12"
    field-of-view="30deg"
  >
    <div slot="ar-button" style="display: none;"></div>
  </model-viewer>

  <script>
    const startButton = document.getElementById('start-ar-button');
    const statusText = document.getElementById('status-text');
    const modelViewer = document.getElementById('pizza-ar-viewer');
    let modelLoaded = false;
    let preloadAttempted = false;

    console.log("Script iniciado. Tentando carregar modelo de:", modelViewer.src);

    const preloadModel = async () => {
      preloadAttempted = true;
      console.log("preloadModel chamado. modelViewer.loaded:", modelViewer.loaded);

      if (modelViewer.loaded) {
        modelLoaded = true;
        console.log("Modelo já estava carregado (modelViewer.loaded era true no início do preloadModel).");
        statusText.textContent = "Modelo pronto. Clique para iniciar RA.";
        startButton.disabled = false;
        return;
      }

      // Garante que o model-viewer esteja 'display: block' para permitir o carregamento.
      // Ele já está posicionado fora da tela pelo CSS.
      modelViewer.style.display = 'block';
      console.log("model-viewer display set to 'block' for preloading.");

      try {
        // Espera o componente <model-viewer> estar pronto e ter tentado carregar o src.
        // Isso não garante que o *modelo* esteja carregado, mas sim que o componente está inicializado.
        console.log("Aguardando modelViewer.updateComplete...");
        await modelViewer.updateComplete;
        console.log("modelViewer.updateComplete resolvido. modelViewer.loaded:", modelViewer.loaded);
        
        if (modelViewer.loaded) {
            modelLoaded = true;
            console.log("Modelo carregado após modelViewer.updateComplete.");
            statusText.textContent = "Modelo pronto. Clique para iniciar RA.";
            startButton.disabled = false;
            modelViewer.style.display = 'none'; // Esconde após pré-carregamento bem-sucedido
            return;
        }

        // Se ainda não carregou, aguarda explicitamente o evento 'load' ou 'error'.
        console.log("Modelo não carregado após updateComplete. Aguardando evento 'load' ou 'error'.");
        await new Promise((resolve, reject) => {
          const PRELOAD_TIMEOUT_MS = 60000; // Aumentado para 60 segundos
          let timeoutId = setTimeout(() => {
            const errorMsg = `Tempo de ${PRELOAD_TIMEOUT_MS / 1000}s excedido ao pré-carregar modelo: ${modelViewer.src}. Verifique a URL e sua conexão.`;
            console.error(errorMsg);
            reject(new Error(errorMsg));
          }, PRELOAD_TIMEOUT_MS);

          const loadListener = () => {
            clearTimeout(timeoutId);
            modelLoaded = true;
            console.log("Modelo pré-carregado com sucesso via evento 'load':", modelViewer.src);
            statusText.textContent = "Modelo pronto. Clique para iniciar RA.";
            startButton.disabled = false;
            resolve();
          };

          const errorListener = (event) => {
            clearTimeout(timeoutId);
            const errorDetail = event.detail?.sourceError?.message || event.detail?.message || event.detail || "Erro desconhecido";
            console.error(`Erro explícito ao pré-carregar o modelo (${modelViewer.src}):`, errorDetail, event.detail);
            statusText.innerHTML = `Erro ao carregar modelo (${modelViewer.src.substring(modelViewer.src.lastIndexOf('/')+1)}).<br>Verifique o console e a conexão.`;
            startButton.disabled = false; 
            reject(new Error(`Erro no pré-carregamento do modelo: ${errorDetail}`));
          };
          
          modelViewer.addEventListener('load', loadListener, { once: true });
          modelViewer.addEventListener('error', errorListener, { once: true });
        });

      } catch (error) {
        console.error("Falha na função preloadModel:", error.message);
        statusText.innerHTML = `Falha ao preparar modelo: ${error.message}<br>Tente recarregar ou verifique a conexão.`;
        startButton.disabled = false;
      } finally {
        // Se o modelo carregou, esconda o model-viewer (que estava 'block' para preload).
        // Se não carregou, ele já estará 'none' ou o usuário verá a mensagem de erro.
        if (modelLoaded) {
            modelViewer.style.display = 'none';
            console.log("Modelo carregado, model-viewer display set to 'none'.");
        } else if (modelViewer.style.display === 'block') {
            // Se houve erro e ele ainda estava block, esconde.
            modelViewer.style.display = 'none';
            console.log("Pré-carregamento falhou, model-viewer display set to 'none'.");
        }
      }
    };

    // Inicia o pré-carregamento
    startButton.disabled = true;
    statusText.innerHTML = "Preparando modelo, por favor aguarde...<br>(Isso pode levar até um minuto)";
    preloadModel();

    startButton.addEventListener('click', async () => {
      console.log("Botão 'Iniciar Realidade Aumentada' clicado.");
      startButton.disabled = true;
      statusText.textContent = "Iniciando...";
      
      modelViewer.style.display = 'block'; // Torna visível para AR
      modelViewer.style.width = '100vw'; 
      modelViewer.style.height = '100vh';
      modelViewer.style.position = 'fixed'; 
      modelViewer.style.left = '0';
      modelViewer.style.top = '0';
      modelViewer.style.zIndex = '1000'; 
      console.log("model-viewer preparado para AR (display: block, fullscreen).");

      if (!modelLoaded) {
        statusText.innerHTML = "Aguardando carregamento final do modelo...<br>Verifique sua conexão.";
        console.log("Modelo não estava pré-carregado, tentando carregar agora para AR.");
        try {
          if (!modelViewer.loaded) {
            await new Promise((resolve, reject) => {
              const finalLoadTimeout = setTimeout(() => reject(new Error("Tempo excedido ao carregar modelo para AR (final).")), 30000); // 30s timeout para esta etapa
              
              const finalLoadListener = () => { clearTimeout(finalLoadTimeout); modelLoaded = true; resolve(); };
              const finalErrorListener = (event) => { 
                clearTimeout(finalLoadTimeout); 
                const errorDetail = event.detail?.sourceError?.message || event.detail?.message || "Erro desconhecido";
                reject(new Error(`Erro ao carregar modelo para AR (final): ${errorDetail}`));
              };

              modelViewer.addEventListener('load', finalLoadListener, { once: true });
              modelViewer.addEventListener('error', finalErrorListener, { once: true });
            });
          } else {
            modelLoaded = true; 
          }
          console.log("Modelo carregado e pronto para AR (no clique).");
        } catch (err) {
          console.error("Erro durante o carregamento para AR (no clique):", err.message);
          statusText.innerHTML = "Erro ao carregar modelo: " + err.message + "<br>Tente novamente.";
          startButton.disabled = false;
          modelViewer.style.display = 'none'; 
          return;
        }
      }

      statusText.textContent = "Iniciando Realidade Aumentada...";
      await new Promise(r => setTimeout(r, 500)); 

      try {
        console.log("Tentando ativar AR (modelViewer.activateAR())...");
        await modelViewer.activateAR();
        console.log("Comando activateAR() enviado. Aguardando status da sessão AR...");
      } catch (err) {
        console.error("Erro ao chamar activateAR():", err.message);
        statusText.innerHTML = "Erro ao iniciar RA: " + err.message + "<br>Verifique permissões e suporte do dispositivo.";
        startButton.disabled = false;
        modelViewer.style.display = 'none'; 
      }
    });

    modelViewer.addEventListener('ar-status', (event) => {
        console.log('AR Status Event:', event.detail.status);
        const arControls = document.getElementById('ar-controls');
        switch(event.detail.status) {
            case 'not-presenting':
                statusText.textContent = "RA finalizada. Clique para iniciar novamente.";
                startButton.disabled = false;
                modelViewer.style.display = 'none'; 
                if (arControls) arControls.style.display = 'flex';
                break;
            case 'session-started':
                statusText.textContent = "RA ativa. Mova seu dispositivo para encontrar uma superfície.";
                if (arControls) arControls.style.display = 'none';
                break;
            case 'failed':
                statusText.innerHTML = "Falha ao iniciar a sessão de RA.<br>Verifique permissões/suporte do dispositivo.";
                startButton.disabled = false;
                modelViewer.style.display = 'none';
                if (arControls) arControls.style.display = 'flex';
                break;
            case 'consent-needed': // O model-viewer geralmente lida com o prompt.
                 statusText.textContent = "Permissão necessária para RA.";
                 console.log("AR consent needed.");
                 break;
        }
    });

    // Opcional: Adicionar um listener para o evento 'progress' para feedback de carregamento
    modelViewer.addEventListener('progress', (event) => {
        if (!modelLoaded && preloadAttempted) { // Apenas durante o pré-carregamento inicial
            const percentage = Math.floor(event.detail.totalProgress * 100);
            // console.log(`Progresso do carregamento: ${percentage}%`);
            statusText.innerHTML = `Carregando modelo: ${percentage}%<br>Por favor, aguarde...`;
        }
    });

  </script>
</body>
</html>
