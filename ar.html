<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Forno de Pizza - RA em Tamanho Grande Aprimorado</title>
  <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.5.0/model-viewer.min.js"></script>
  <style>
    body {
      margin: 0;
      background-color: #f0f0f0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      color: #333;
      text-align: center;
      padding: 16px;
      box-sizing: border-box;
    }
    #ar-controls {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
      padding: 20px;
      background-color: #ffffff;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      z-index: 10;
    }
    #start-ar-button {
      background-color: #007aff;
      color: white;
      padding: 14px 28px;
      border: none;
      border-radius: 8px;
      font-size: 18px;
      font-weight: 500;
      cursor: pointer;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      transition: background-color 0.3s ease, transform 0.1s ease;
    }
    #start-ar-button:hover {
      background-color: #005ecb;
    }
    #start-ar-button:active {
      transform: scale(0.98);
    }
    #start-ar-button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    #status-text {
      color: #555;
      font-size: 15px;
      min-height: 60px; 
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column; 
    }
    model-viewer {
      display: none; /* Começa escondido, será mostrado ao clicar no botão */
      width: 100vw; /* Ocupará tela cheia quando visível para AR */
      height: 100vh;
      position: fixed; /* Para sobrepor outros elementos */
      top: 0;
      left: 0;
      z-index: 1000; /* Para ficar na frente */
      background-color: #f0f0f0; /* Cor de fundo enquanto carrega */
    }
  </style>
</head>
<body>
  <div id="ar-controls">
    <h1>Forno de Pizza em Realidade Aumentada</h1>
    <button id="start-ar-button">Iniciar Realidade Aumentada</button>
    <div id="status-text">Verificando compatibilidade...</div>
    <p style="font-size: 12px; color: #777;">Certifique-se de que seu ambiente está bem iluminado e aponte para uma superfície plana.</p>
  </div>

  <model-viewer
    id="pizza-ar-viewer"
    src="https://raw.githubusercontent.com/julianambatista/PizzaOven/main/pizza%20oven_resized.glb"
    poster="https://placehold.co/600x400/FF6347/FFFFFF?text=Forno+de+Pizza\nCarregando..." /* Imagem de placeholder */
    alt="Forno de Pizza em RA"
    ar
    ar-modes="webxr scene-viewer quick-look"
    ar-placement="floor"
    ar-scale="fixed"
    ar-stability="medium"
    autoplay
    shadow-intensity="1"
    exposure="1.0"
    disable-tap
    camera-controls /* Habilitado para visualização 3D antes da RA */
    disable-pan
    min-camera-orbit="auto 30deg auto"
    max-camera-orbit="auto 100deg auto"
    interaction-prompt="auto" /* 'auto' para mostrar prompt se necessário */
    scale="12 12 12"
    field-of-view="30deg"
  >
    <div slot="ar-button" style="display: none;"></div> </model-viewer>

  <script>
    const startButton = document.getElementById('start-ar-button');
    const statusText = document.getElementById('status-text');
    const modelViewer = document.getElementById('pizza-ar-viewer');
    let modelLoaded = false;
    let arActivationAttempted = false;

    console.log("Script iniciado. Modelo SRC:", modelViewer.src);

    const checkXRSupport = () => {
      if (navigator.xr) {
        console.log("WebXR é suportado.");
        statusText.innerHTML = "Dispositivo compatível.<br>Clique no botão para carregar o modelo (7.2MB).";
        startButton.disabled = false;
      } else {
        console.warn("WebXR não é suportado neste navegador/dispositivo.");
        statusText.innerHTML = "Realidade Aumentada (WebXR) pode não ser totalmente suportada.<br>Modos alternativos (como visualizador 3D) podem funcionar.";
        startButton.disabled = false; // Permite tentar com scene-viewer/quick-look
      }
    };

    checkXRSupport(); // Verifica o suporte ao carregar a página

    const loadAndActivateAR = async () => {
      startButton.disabled = true;
      arActivationAttempted = true;
      
      // Mostra o model-viewer agora, ele exibirá o poster enquanto carrega.
      modelViewer.style.display = 'block';
      console.log("model-viewer display set to 'block'. Iniciando carregamento do modelo...");
      statusText.innerHTML = "Carregando modelo (aprox 7.2MB)...<br>Isso pode levar até 2 minutos. Por favor, aguarde.";

      try {
        if (!modelLoaded) { // Só carrega se ainda não foi carregado
          // O evento 'load' será disparado quando o modelo estiver pronto
          // O evento 'progress' já está configurado para dar feedback
          await new Promise((resolve, reject) => {
            const LOAD_TIMEOUT_MS = 120000; // Aumentado para 120 segundos (2 minutos)
            let timeoutId = setTimeout(() => {
              const errorMsg = `Tempo de ${LOAD_TIMEOUT_MS / 1000}s excedido ao carregar modelo: ${modelViewer.src}.<br>Verifique sua conexão ou tente novamente. O arquivo é grande (7.2MB).<br>Considere otimizar o modelo 3D.`;
              console.error(errorMsg.replace(/<br>/g, ' '));
              reject(new Error(errorMsg));
            }, LOAD_TIMEOUT_MS);

            const loadListener = () => {
              clearTimeout(timeoutId);
              modelLoaded = true;
              console.log("Modelo carregado com sucesso:", modelViewer.src);
              statusText.textContent = "Modelo carregado! Iniciando Realidade Aumentada...";
              resolve();
            };

            const errorListener = (event) => {
              clearTimeout(timeoutId);
              const errorDetail = event.detail?.sourceError?.message || event.detail?.message || event.detail || "Erro desconhecido";
              console.error(`Erro explícito ao carregar o modelo (${modelViewer.src}):`, errorDetail, event.detail);
              statusText.innerHTML = `Erro ao carregar modelo.<br>Detalhe: ${errorDetail}.<br>Verifique o console e a conexão.`;
              startButton.disabled = false; 
              modelViewer.style.display = 'none'; // Esconde se falhar
              reject(new Error(`Erro no carregamento do modelo: ${errorDetail}`));
            };
            
            // Remove listeners antigos para evitar duplicação se o botão for clicado múltiplas vezes após um erro
            modelViewer.removeEventListener('load', loadListener);
            modelViewer.removeEventListener('error', errorListener);

            modelViewer.addEventListener('load', loadListener, { once: true });
            modelViewer.addEventListener('error', errorListener, { once: true });

            // Se o model-viewer já tiver o src e não estiver carregado, ele tentará carregar.
            // Se o src for alterado dinamicamente, isso também acionaria o carregamento.
            // Como o src já está definido no HTML, o carregamento começa quando o componente é renderizado
            // e o modelViewer.style.display = 'block' é chamado.
          });
        } else {
           statusText.textContent = "Modelo já carregado. Iniciando Realidade Aumentada...";
        }

        // Aguarda um pouco para o usuário ler a mensagem de "Modelo Carregado"
        await new Promise(r => setTimeout(r, 1000)); 
        
        console.log("Tentando ativar AR (modelViewer.activateAR())...");
        if (!modelViewer.canActivateAR) {
            console.warn("modelViewer.canActivateAR é false.");
            statusText.innerHTML = "Não foi possível ativar RA.<br>Seu dispositivo pode não suportar os modos de RA necessários (WebXR, SceneViewer ou QuickLook).";
            startButton.disabled = false; // Permite tentar novamente ou usar visualizador 3D
            // Não esconder o model-viewer aqui, pois pode estar mostrando o modelo em 3D
            return;
        }
        await modelViewer.activateAR();
        console.log("Comando activateAR() enviado. Aguardando status da sessão AR...");
        // O status da sessão AR será tratado pelo evento 'ar-status'

      } catch (error) {
        console.error("Falha na função loadAndActivateAR:", error.message);
        // A mensagem de erro já deve ter sido definida pelo listener de erro do modelo ou pelo timeout
        if (!statusText.innerHTML.includes("Erro")) { // Evita sobrescrever mensagem de erro mais específica
            statusText.innerHTML = `Falha ao iniciar: ${error.message.replace(/\n/g, '<br>')}`;
        }
        startButton.disabled = false;
        if (!modelLoaded) modelViewer.style.display = 'none'; // Esconde se o modelo nem carregou
      }
    };

    startButton.addEventListener('click', loadAndActivateAR);

    modelViewer.addEventListener('ar-status', (event) => {
        console.log('AR Status Event:', event.detail.status);
        const arControls = document.getElementById('ar-controls');
        switch(event.detail.status) {
            case 'not-presenting':
                statusText.textContent = "RA finalizada. Clique para iniciar novamente.";
                startButton.disabled = false;
                modelViewer.style.display = 'none'; // Esconde o model-viewer ao sair da RA
                if (arControls) arControls.style.display = 'flex';
                arActivationAttempted = false;
                break;
            case 'session-started':
                statusText.textContent = "RA ativa! Mova seu dispositivo para encontrar uma superfície.";
                if (arControls) arControls.style.display = 'none'; // Esconde os controles da página
                break;
            case 'failed':
                statusText.innerHTML = "Falha ao iniciar a sessão de RA.<br>Verifique permissões e suporte do dispositivo.";
                startButton.disabled = false;
                modelViewer.style.display = 'none'; 
                if (arControls) arControls.style.display = 'flex';
                arActivationAttempted = false;
                break;
            case 'consent-needed': 
                 statusText.textContent = "Permissão necessária para RA.";
                 console.log("AR consent needed.");
                 break;
        }
    });

    modelViewer.addEventListener('progress', (event) => {
        // Só mostra o progresso se o AR ainda não foi ativado e o carregamento está em andamento
        if (!arActivationAttempted && !modelLoaded && modelViewer.style.display === 'block') { 
            const percentage = Math.floor(event.detail.totalProgress * 100);
            statusText.innerHTML = `Carregando modelo (7.2MB): ${percentage}%<br>Por favor, aguarde...`;
        }
    });

  </script>
</body>
</html>
